@model  AdvanceCRM.Modules.ThirdParty.IVRDetails.IVRKnowlarityModel
@inject Serenity.ITextLocalizer Localizer
@{
    ViewData["Title"] = "IVR Knowlarity";
}
@section Head {
    <link rel="stylesheet" href="~/Content/iCheck/flat/blue.css" />
    <script type="text/javascript" src="//cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.js"></script>
    <link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
    <script src="~/Scripts/jquery.icheck.min.js"></script>
    <script src="tableExport/tableExport.js"></script>
    <script src="~/Scripts/adminlte/demo.js"></script>
    <script type="text/javascript" src="https://unpkg.com/xlsx@0.15.1/dist/xlsx.full.min.js"></script>
    }

<script type="text/javascript">
    function ExportToExcel(type, fn, dl) {
        var elt = document.getElementById('table');
        var wb = XLSX.utils.table_to_book(elt, { sheet: "sheet1" });
        return dl ?
            XLSX.write(wb, { bookType: type, bookSST: true, type: 'base64' }) :
            XLSX.writeFile(wb, fn || ('MySheetName.' + (type || 'xlsx')));
    }




   function NewEnquiry() {
       Q.initFullHeightGridPage($('#DivId'));
       new AdvanceCRM.Enquiry.EnquiryDialog().loadNewAndOpenDialog();
    }
    //function Export() {
    //    $("table").table2excel({
    //        filename: "Table.xls"
    //    });
    //}
    function exportF(elem) {
        var table = document.getElementById("table");
        var html = table.outerHTML;
        var url = 'data:application/vnd.ms-excel,' + escape(html); // Set your html table into url
        elem.setAttribute("href", url);
        elem.setAttribute("download", "export.xls"); // Choose the file name
        return false;
    }
   function LoadData() {
       $.ajax({
           url: '@Url.Action("LoadKnowlarityData", "IVR")?StartDate=' + encodeURIComponent($('#@Html.IdFor(m=> m.StartDate)').val()) + '&EndDate=' + encodeURIComponent($('#@Html.IdFor(m=> m.EndDate)').val()) + '&Index=' + $("#ListId").val(),
                   type: 'GET',
                   data: "",
                   contentType: 'application/json; charset=utf-8',
                   success: function (data) {
                       $("#DivId").html(data);
                   },
                        error: function (jqXHR, exception) {
                            var msg = '';
                            if (jqXHR.status === 0) {
                                msg = 'Not connect.\n Verify Network.';
                            } else if (jqXHR.status == 404) {
                                msg = 'Requested page not found. [404]';
                            } else if (jqXHR.status == 500) {
                                msg = 'Internal Server Error [500].';
                            } else if (exception === 'parsererror') {
                                msg = 'Requested JSON parse failed.';
                            } else if (exception === 'timeout') {
                                msg = 'Time out error.';
                            } else if (exception === 'abort') {
                                msg = 'Ajax request aborted.';
                            } else {
                                msg = 'Uncaught Error.\n' + jqXHR.responseText;
                            }
                            toastr.error(msg);
                   }
               });

    }



   $(function () {

       $('input[name="DateRange"]').daterangepicker({
            locale: {
                format: 'DD/MM/YYYY'
            },
            startDate: $('#@Html.IdFor(m=> m.StartDate)').val(),
            endDate: $('#@Html.IdFor(m=> m.EndDate)').val()
       });

       $('input[name="DateRange"]').on('apply.daterangepicker', function (ev, picker) {
               $("#StartDate").val(picker.startDate.format('DD/MM/YYYY'));
               $("#EndDate").val(picker.endDate.format('DD/MM/YYYY'));
           $(this).val($("#StartDate").val() + ' - ' + $("#EndDate").val());
           LoadData();
       });



       $("#ListId").on('change', function () {
           $("#ListId").val(this.value);

           if ($("#ListId").val() == "")
               return;

           LoadData();
       });
   });
</script>
@section ContentHeader {
    <h1>@ViewData["Title"]</h1>
}
<div class="row">
    <!-- /.col -->
    <div class="col-md-12">
        <div class="box box-primary">
            <div class="box-header with-border">
                @*
                    <h3 class="box-title">Inbox</h3>
                *@
                <div class="row col-md-12">
                    <div class="col-md-3">
                        <div class="box-tools">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-phone"></i>
                                    </div>
                                    <select class="form-control" id="ListId">
                                        @if (Model.IVRNumbers == null)
                                        {
                                            <option>IVR Numbers</option>
                                        }
                                        else
                                        {
                                            int cnt = 0;
                                            foreach (var itm in Model.IVRNumbers)
                                            {
                                                <option value="@cnt">@itm</option>
                                                cnt = cnt + 1;
                                            }
                                        }
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="box-tools">
                            <!-- Date range -->
                            <div class="form-group">
                                @*<label>Date range:</label>*@
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-calendar"></i>
                                    </div>
                                    <input type="text" class="form-control pull-right" name="DateRange">
                                </div>
                                <!-- /.input group -->
                            </div>
                            <!-- /.form group -->
                            <!-- Date and time range -->
                        </div>
                    </div>

                    <div class="col-md-3">
                        @*<div class="form-group-sm  pull-right">
                                <a id="downloadLink" onclick="exportF(this)" style="font-size:larger">Export to Excel</a>
                            </div>*@
                        <button onclick="ExportToExcel('xlsx')">Export table to excel</button>
                    </div>


                    <div class="has-feedback">
                        <div class="form-group-sm  pull-right">
                            <button class="pull-right btn btn-default" id="launchEnquiry" onclick="NewEnquiry();">Launch Enquiry <i class="fa fa-arrow-circle-right"></i></button>
                        </div>
                    </div>
                </div>
                <!-- /.box-tools -->
            </div>

            @using (Html.BeginForm("Index", "IVR", FormMethod.Get))
            {
                @Html.HiddenFor(x => x.EndDate)
                @Html.HiddenFor(x => x.StartDate)
                @Html.HiddenFor(x => x.Type)
                @Html.HiddenFor(x => x.Page)
                <!-- /.box-header -->
                <div id="DivId">
                    @Html.Partial(MVC.Views.ThirdParty.IVRDetails.IVRKnowlarityData, Model)
                    <!-- /.box-body -->
                </div>

            }
        </div>
        <!-- /. box -->
    </div>
    <!-- /.col -->
</div>
<!-- /.row -->